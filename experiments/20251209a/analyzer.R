# Load the necessary libraries
library(nlme)
library(dplyr) 

# --- 1. Load and Prepare Data ---

# Read the TSV file generated by the Python script.
# NOTE: The filename MUST match the output of your Python script (clean_data.tsv).
data_raw <- read.table("Experiment_20251209a.tsv", # "trimmed.tsv"
                       header = TRUE, 
                       sep = "\t", 
                       na.strings = "NA", # Treat the string "NA" from Python output as a missing value
                       stringsAsFactors = FALSE)

# Remove all rows containing any missing data (NA) from the required columns
data_clean <- na.omit(data_raw) 

# Create a simple numeric time index for the AR(1) correlation structure
data_clean$time_index <- 1:nrow(data_clean)


# --- 2. Create the Binary Controller State (ON/OFF) ---

# A. Calculate the threshold (using the mean of the 'current' column)
# This is used to define the "ON" vs. "OFF" state of the controller.
threshold <- mean(data_clean$current)
cat(paste("Calculated Current Threshold for ON/OFF State:", round(threshold, 4), "\n"))

# B. Create the Binary Controller State (1 = ON, 0 = OFF)
data_clean <- data_clean %>%
  mutate(
    # Current > threshold is defined as "ON" (1), otherwise "OFF" (0)
    controller_state = as.integer(current > threshold)
  )

# Group the cleaned data by the controller factor (OFF or ON)
# and calculate the mean methane level and the count of observations for each group.
mean_methane_by_state <- data_clean %>%
  group_by(controller_f) %>%
  summarize(
    Mean_Methane = mean(methane, na.rm = TRUE),
    N_Observations = n()
  )

# Display the results
cat("\n--- Mean Methane Levels by Controller State ---\n")
print(mean_methane_by_state)

# C. Convert the state to a factor for proper interpretation in the model summary
data_clean$controller_f <- factor(data_clean$controller_state, labels = c("OFF", "ON"))

# --- 3. Run the Generalized Least Squares (GLS) Model ---

# Model: Methane is predicted by the binary controller state.
# Correlation: Accounts for time-series autocorrelation using an AR(1) structure.
gls_model <- gls(
  model = methane ~ controller_f, 
  data = data_clean,
  correlation = corAR1(form = ~ time_index), 
  method = "REML" 
)

# Display the final model results (coefficients, standard errors, p-values)
summary(gls_model)
